# 第七章。PHP 编程的最佳实践

到目前为止，我们讨论了与性能相关的主题。现在，在本章中，我们将学习 PHP 应用程序开发和部署的最佳实践。这是一个广泛的主题，但我们将简要介绍。PHP 为所有级别的程序员提供了编写高质量代码的能力。然而，当应用程序变得更加复杂时，我们忘记了遵循最佳实践。为了开发高性能的 PHP 应用程序，有必要在代码的每一行都考虑性能。

我们将涵盖以下主题：

+   编码风格

+   设计模式

+   面向服务的架构（SOA）

+   测试驱动开发（TDD）和 PHPUnit 测试

+   PHP 框架

+   版本控制系统和 Git

+   部署

# 编码风格

有太多的编码风格，比如 PSR-0、PSR-1、PSR-2、PSR-3 等等。程序员可以按照自己的意愿使用不同的标准，但有必要遵循已经在库或框架中使用的标准，以使代码更易读。例如，Laravel 使用 PSR-1 和 PSR-4 编码标准，所以如果我们在 Laravel 中开发，就应该遵循这些编码标准。一些 PHP 框架，比如 Yii 2 和 Zend Framework 2，遵循 PSR-2 编码标准。然而，这些框架都没有坚持单一标准；大多数都根据自己的需求遵循混合标准。

重要的是要遵循应用程序中使用的库的标准。组织也可以为内部目的使用自己的编码标准。这不是编码的要求，而是可读性和产生他人可以理解的高质量代码的要求。

PHP Framework Interop Group（PHP-FIG）是一个成员定义了 PHP 编码标准的团体。有关 PSR 标准的详细信息可以在他们的网站上找到[`www.php-fig.org/`](http://www.php-fig.org/)。

与讨论特定编码标准不同，让我们讨论 PHP 编码风格的最佳实践：

+   类名中每个单词的首字母必须大写。大括号应该在类声明后的行上，结束括号应该在类结束行的下一行。这是一个例子：

```php
    class Foo
    {
      …
      …
      …
    }
    ```

+   类方法和函数名应遵循驼峰命名约定。起始大括号应该在类声明的下一行，结束括号应该在函数定义的最后一行。方法名和括号之间不应有空格。此外，参数和括号之间不应有空格，参数的逗号之后应有一个空格，但逗号和下一个参数之间应有一个空格。这是一个例子：

```php
    public function phpBook($arg1, $arg2, $arg3)
    {
      …
      …
      …
    }
    ```

+   如果有命名空间声明，声明后必须有一个空行。如果有使用声明，所有使用声明都必须放在该命名空间声明之后。每行必须有一个使用声明，并且在使用块之后必须有一个空格。此外，`extends`和`implements`关键字必须与类声明在同一行上。这是一个例子：

```php
    namespace Packt\Videos;

    use Packt\Books;
    use Packt\Presentations;

    class PacktClass extends VideosClass implements BaseClass
    {
      …
      …
      …
    }
    ```

+   所有属性都必须声明可见性，并且属性必须使用驼峰命名法。此外，私有或受保护的属性不得以下划线开头。看下面的例子：

```php
    class PacktClass
    {
      public $books;
      private $electronicBooks;
      …
      …
      …
    }
    ```

+   如果有`abstract`关键字，它必须在类关键字之前出现，对于方法，`final`关键字必须在方法的可见性之前出现。另一方面，`static`关键字必须在方法可见性之后出现。看一个例子：

```php
    abstract class PacktClass
    {
      final public static function favoriteBooks()
      {
        …
        …
        …
      }
    }
    ```

+   所有 PHP 关键字必须使用小写，包括`true`和`false`关键字。常量必须以大写形式声明和使用。

+   对于所有控制结构，关键字后必须有一个空格。如果有一个表达式用于这个控制结构，那么括号中不应该有空格，后面跟着的代码块也不应该有空格。括号和开始的大括号之间必须有一个空格。开始的大括号必须在同一行上。结束的大括号必须在主体结束的下一行。参考以下代码以更好地理解：

```php
    if ($book == "PHP 7") {
      …
      …
      …
    } else {
      …
      …
      …
    }
    ```

+   在循环的情况下，空格必须如下例所示：

```php
    for ($h = 0; $h < 10; $h++) {
      …
      …
      …
    }

    foreach ($books as $key => $value) {
      …
      …
      …
    }

    while ($book) {
      …
      …
      …
    }
    ```

为了本书的目的，我没有遵循大括号在控制结构声明的同一行上的规则，并且总是在声明的下一行使用它。我觉得这样做并不更清晰；这是个人选择，任何人都可以遵循这里提到的标准。

遵循标准是很好的，因为它们使代码更易读和专业。但是，永远不要试图发明自己的新标准；总是遵循已经被社区发明和遵循的标准。

# 测试驱动开发（TDD）

测试驱动开发是在开发过程中测试应用程序的每个方面。测试可以在开发之前定义，然后进行开发以通过这些测试，或者构建类和库然后进行测试。测试应用程序非常重要，没有测试就启动应用程序就像从 30 层楼高的建筑物上跳下而没有降落伞。

PHP 没有提供任何内置功能来进行测试，但有其他测试框架可以用于此目的。其中最广泛使用的框架或库之一是 PHPUnit。它是一个非常强大的工具，提供了许多功能。现在，让我们来看看它。

PHPUnit 的安装很容易。只需下载并将其放在项目的根目录中，以便可以从命令行访问。

### 注意

PHPUnit 的安装和基本细节，包括功能和示例，可以在[`phpunit.de/`](https://phpunit.de/)找到。

让我们举一个简单的例子。我们有一个`Book`类，如下所示：

```php
class Book 
{
  public $title;
  public function __construct($title)
  {
    $this->title = $title;
}

  public function getBook()
  {
    return $this->title;
  }
}
```

这是一个简单类的示例，当类被实例化时初始化`title`属性。当调用`getBook`方法时，它返回书的标题。

现在，我们想要进行一个测试，检查`getBook`方法是否返回`PHP 7`作为标题。因此，执行以下步骤创建测试：

1.  在项目的根目录下创建一个`tests`目录。在`tests`目录中创建一个`BookTest.php`文件。

1.  现在，将以下代码放入`BookTest.php`文件中：

```php
    include (__DIR__.'/../Book.php');

    class BookTest extends PHPUnit_Framework_TestCase 
    {
      public function testBookClass()
      {
        $expected = 'PHP 7';
        $book = new Book('PHP 7');
        $actual = $book->getBook();
        $this->assertEquals($expected, $book);
      }
    }
    ```

1.  现在，我们已经编写了我们的第一个测试。请注意，我们将我们的类命名为`BookTest`，它继承了`PHPUnit_Framework_TestCase`类。我们可以随意命名我们的测试类。但是，名称应该容易识别，这样我们就知道这是为需要测试的类编写的。

1.  然后，我们添加了一个名为`testBookClass`的方法。我们也可以自由选择给这个方法任何名称，但是它应该以单词`test`开头。如果不是，PHPUnit 将不会执行该方法，并会发出警告——在我们的情况下，对于前面的测试类，没有找到任何测试。

在`testBookClass`方法中，我们创建了一个`Book`类的对象，并将`PHP 7`作为我们的标题传递。然后，我们使用`Book`类的`getBook`方法获取标题。重要的部分是`testBookClass`方法的最后一行，它执行断言并检查从`getBook`返回的数据是否是期望的数据。

1.  现在，我们准备运行我们的第一个测试。在项目的根目录中打开命令行或终端，并发出以下命令：

```php
    **php phpunit.phar tests/BookTest.php**

    ```

当命令被执行时，我们将得到类似以下截图的输出：

![测试驱动开发（TDD）](img/B05225_07_01.jpg)

我们的测试成功执行，因为它满足了我们测试中定义的标准。

1.  现在，让我们稍微改变我们的类，并将`PHP`传递给`Book`类，如下面的代码所示：

```php
    public function testBookClass()
    {
      $book = new Book('PHP');
      $title = $book->getBook();
      $this->assertEquals('PHP 7', $book);
    }
    ```

1.  现在，我们正在寻找 PHP 7，我们的`Book`类返回`PHP`，所以它没有通过我们的测试。执行此测试后，我们将会失败，如下面的截图所示：![测试驱动开发（TDD）](img/B05225_07_02.jpg)

如前面的截图所示，我们期望得到`PHP 7`，而实际结果是`PHP 7`。`-`符号显示了期望值，`+`符号显示了实际值。

### 注意

在前面的主题中，我们讨论了如何对我们的库执行测试。我们只讨论了一个简单的基本测试。PHPUnit 不仅限于这些简单的测试，但完全覆盖 PHPUnit 超出了本书的范围。一本关于 PHPUnit 的很好的书是 Packt Publishing 出版的*PHPUnit Essentials*。

# 设计模式

设计模式解决特定问题。它不是一个工具；它只是描述或模板，描述如何解决特定问题。设计模式很重要，在编写清晰的代码方面起着很好的作用。

在 PHP 社区中最广泛使用的设计模式之一是**模型视图控制器**（**MVC**）模式。大多数 PHP 框架都建立在这种模式之上。MVC 建议将业务逻辑和数据操作（即模型）与表示（视图）分开。控制器只是在模型和视图之间充当中间人的角色，并使它们之间的通信成为可能。模型和视图之间没有直接的通信。如果视图需要任何类型的数据，它会向控制器发送请求。控制器知道如何处理这个请求，并在需要时调用模型对数据进行任何操作（获取、插入、验证、删除等）。然后最后，控制器向视图发送响应。

在最佳实践中，使用肥模型和瘦控制器。这意味着控制器仅用于对请求执行特定操作，而不做其他事情。甚至在一些现代框架中，验证被移出控制器，并在模型层执行。这些模型执行所有数据操作。在现代框架中，模型被视为一个层，可以有多个部分，如业务逻辑、**创建读取更新删除**（**CRUD**）数据库操作、数据映射器模式和服务等。因此，模型和控制器的全部负载只是坐在那里，享受懒惰的工作负载。

另一个广泛使用的设计模式是工厂设计模式。这种模式简单地创建需要使用的对象。另一个好的模式是观察者模式，其中一个对象在特定事件或任务上调用不同的观察者。这主要用于事件处理。另一个广泛使用的模式是单例模式，当需要在应用程序执行期间仅使用类的单个对象时使用。单例对象无法序列化和克隆。

# 面向服务的架构（SOA）

在面向服务的架构中，应用程序的组件在定义的协议上为彼此提供服务。每个组件之间松散耦合，它们之间的通信方式是通过它们提供的服务。

在 PHP 中，Symfony 提供了拥有 SOA 的最佳方式，因为它主要是一个以 HTTP 为中心的框架。Symfony 是最成熟、经过充分测试的库集合，被其他 PHP 框架广泛使用，如 Zend Framework、Yii、Laravel 等。

让我们考虑一个情景，我们有一个网站和一个移动应用的后端和前端。通常，在大多数应用程序中，后端和前端在同一代码库和单一访问点上运行，并且为移动应用构建了一个 API 或 Web 服务来与后端通信。这很好，但我们需要更好。因此，对于高性能和可扩展的应用程序，各个组件独立运行。如果它们需要相互通信，它们通过 Web 服务进行通信。

Web 服务是前端和后端之间以及后端和移动应用之间的中心通信点。后端是数据和任何其他业务逻辑的主要枢纽。它可以独立运行，并使用任何编程语言构建，比如 PHP。前端可以使用普通的 HTML/CSS、AngularJS、Node.js、jQuery 或任何其他前端技术构建。同样，移动应用可以是原生的，也可以基于跨平台技术构建。后端不关心前端和移动应用是基于什么构建的。

# 始终是面向对象和可重用的

对于一个小型的单页应用程序来说，这可能看起来很困难，只有少数事情发生，但事实并非如此。类很容易处理，代码始终清晰。此外，类将应用程序逻辑与视图分离。这使得事情更加合乎逻辑。在早期使用结构化代码和必须在视图文件或单独文件中创建一堆函数时，这将变得太容易。然而，当应用程序变得更加复杂时，处理起来就更加困难。

始终尝试创建松耦合的类，使它们在其他应用程序中更具重用性。此外，始终在类的每个方法中执行单个任务。

# PHP 框架

我们都知道框架，并且它们对程序员的生活并非必不可少。有很多框架，每个框架在某些功能上都有其自身的优势。所有框架都很好，但使框架不适合应用程序的是应用程序的需求。

假设我们想构建一个企业级的 CRM 应用程序，哪种框架最适合我们？这是最重要、最令人困惑和最浪费时间的问题。首先，我们需要了解 CRM 应用程序的完整需求、使用容量、功能、数据安全性和性能。

# 版本控制系统（VCS）和 Git

版本控制系统提供了灵活性，可以正确地维护应用程序的代码、更改和版本。使用 VCS，整个团队可以共同在一个应用程序上工作，他们可以从系统中拉取其他团队成员的更改和自己的更改，而不会有太大的麻烦。在灾难发生时，VCS 提供了回退到旧的、更稳定版本的应用程序的能力。

哦等等！我们在谈论版本控制系统吗？我们提到了 Git 吗？没有！所以，让我们从 Git 开始。

Git 是一个强大的工具。它监视分支中每个文件的更改，当推送到远程分支时，只上传更改的文件。Git 保留文件更改的历史记录，并提供您比较更改文件的能力。

### 注意

关于 Git 的一本非常信息丰富且优秀的书是 Packt Publishing 出版的*Git Essentials*。此外，关于 Git 的官方免费书籍可以在[`git-scm.com/book/en/v2`](https://git-scm.com/book/en/v2)找到。

# 部署和持续集成（CI）

FTP 已经过时。对于今天来说不可行，它会使事情变慢，而且普通的 FTP 连接是不安全的。团队使用 FTP 部署其更改是困难的，因为它会在他们的代码中造成巨大的冲突，这可能会在上传更改时造成问题，并且可能会覆盖彼此的更改。

使用 Git 版本控制系统，如 GitHub、GitLab 和 Bitbucket，我们可以使部署自动化。不同的开发人员使用不同的自动部署设置，这完全取决于他们自己的选择和便利性。使用自动部署的一般规则是使团队易于使用，并且不使用 FTP。

以下是部署设置的一般流程图：

![部署和持续集成（CI）](img/B05225_07_03.jpg)

如前面的流程图所示，我们有两个服务器：暂存或测试服务器和生产服务器。在暂存服务器上，我们有网站的精确副本，用于测试新功能和其他内容，而生产服务器则有我们的实时网站。

现在，我们有一个具有两个主要分支的存储库：主分支和生产分支。主分支用于开发和测试目的，而生产分支用于最终生产功能。请注意，生产分支应仅接受合并，不应接受提交，以便生产环境完全安全。

现在，假设我们想要向我们的应用程序添加客户注册功能。我们将执行以下步骤：

1.  首先，也是最重要的是从生产分支头部创建一个新分支。让我们将此分支命名为`customer-registration`。

1.  现在，将所有新功能添加到`customer-registration`分支，并在本地开发服务器上验证后，将此分支合并到本地主分支。

1.  将新分支合并到本地主分支后，将主分支推送到远程主分支。成功推送将导致新功能移动到暂存服务器。

1.  现在，在暂存服务器上测试所有新功能。

1.  当一切正常时，将远程主分支与远程生产分支合并。这将导致所有更改移动到生产分支，并且此合并将导致所有新更改移动到生产服务器。

1.  类似于前面的设置，一个理想的设置使部署非常容易，整个团队可以在不同的地理位置工作应用程序。如果在部署过程中出现任何问题，可以轻松地回退到旧版本的生产分支。

**持续集成**（**CI**）是一种技术，团队的所有成员都必须将其代码集成到共享存储库中，然后团队成员的每次检查都经过自动构建进行验证，以捕获早期阶段的错误和问题。

有几种用于 PHP 的 CI 工具；其中一些是 PHPCI、Jenkins、Travis CI 等。

# 总结

在本章中，我们讨论了一些最佳实践，包括编码标准和风格、PHP 框架、设计模式、Git 和部署。此外，我们还讨论了 PHPUnit 框架，用于对类和库进行测试。此外，我们还讨论了面向服务的设计，在为应用程序创建 API 方面发挥了重要作用。

在本书中，我们研究了设置开发环境，包括 Linux 服务器，特别是 Debian 和 Ubuntu，我们还讨论了 Vagrant。还列出了 PHP 的新功能，并附有示例代码。您可以详细了解我们可以使用的工具，以提高应用程序和数据库的性能。此外，我们还讨论了调试和应力或负载测试我们的应用程序以及编写高质量代码的一些最佳实践。

我们主要总结了工具和技术，并提供了简单的示例，向读者介绍这些工具和技术。每种工具和技术都有可能有自己的书籍，用于更高级的用途。我们建议您跟进这些工具和技术，并进行更多的研究以了解其高级用途。祝您 Php-ing 好运！
