["```php\n1 <?php\n2 // ...\n3 require 'includes/setup.php';\n4 // ...\n5\n6 $article_types = array(1, 2, 3, 4, 5);\n7 $failure = array();\n8 $now = time();\n9\n10 // sanitize and escape the user input\n11 $input = $_POST;\n12 $input['body'] = strip_tags($input['body']);\n13 $input['notes'] = strip_tags($input['notes']);\n14 foreach ($input as $key => $val) {\n15 $input[$key] = mysql_real_escape_string($val);\n16 }\n17\n18 if (isset($input['ready']) && $input['ready'] == 'on') {\n19 $input['ready'] = 1;\n20 } else {\n21 $input['ready'] = 0;\n22 }\n23\n24 // nothing less than 0.01 credits per rating\n25 $input['credits_per_rating'] = round(\n26 $input['credits_per_rating'],\n27 2\n28 );\n29\n30 $credits = round(\n31 $input['credits_per_rating'] * $input['max_ratings'],\n32 2\n33 );\n34\n35 // updating an existing article?\n36 if ($input['id']) {\n37\n38 // make sure this article belongs to the user\n39 $stm = \"SELECT *\n40 FROM articles\n41 WHERE user_id = '{$user_id}'\n42 AND id = '{$input['id']}'\n43 LIMIT 1\";\n44 $result = mysql_query($stm);\n45\n46 if (mysql_num_rows($result)) {\n47\n48 // get the existing article from the database\n49 $row = mysql_fetch_assoc($result);\n50\n51 // don't charge unless the article is ready\n52 $decrement = false;\n53\n54 // is the article marked as ready?\n55 if ($input['ready'] == 1) {\n56\n57 // did they offer at least the minimum?\n58 if (\n59 $credits > 0\n60 && $input['credits_per_rating'] >= 0.01\n61 && is_numeric($credits)\n62 ) {\n63\n64 // was the article previously ready for review?\n65 // (note 'row' not 'input')\n66 if ($row['ready'] == 1) {\n67\n68 // only subtract (or add back) the difference to their\n69 // account, since they already paid something\n70 if (\n71 is_numeric($row['credits_per_rating'])\n72 && is_numeric($row['max_ratings'])\n73 ) {\n74 // user owes $credits, minus whatever they paid already\n75 $amount = $row['credits_per_rating']\n76 * $row['max_ratings']\n77 $credits = $credits - $amount;\n78 }\n79\n80 $decrement = true;\n81\n82 } else {\n83 // article not ready previously, so they hadn't\n84 // had credits deducted. if this is less than their\n85 // in their account now, they may proceed.\n86 $residual = $user->get('credits') - $credits;\n87 $decrement = true;\n88 }\n89\n90 } else {\n91 $residual = -1;\n92 $failure[] = \"Credit offering invalid.\";\n93 $decrement = false;\n94 }\n95\n96 } else {\n97\n98 // arbitrary positive value; they can proceed\n99 $residual = 1;\n100\n101 // if it was previously ready but is no longer, refund them\n102 if (\n103 is_numeric($row['credits_per_rating'])\n104 && is_numeric($row['max_ratings'])\n105 && ($row['ready'] == 1)\n106 ) {\n107 // subtract a negative value\n108 $amount = $row['credits_per_rating']\n109 * $row['max_ratings']\n110 $credits = -($amount);\n111 $decrement = true;\n112 }\n113 }\n114\n115 if ($residual >= 0) {\n116\n117 if (strlen($input['notes'])>0) {\n118 $notes = \"notes = '{$input['notes']}'\";\n119 } else {\n120 $notes = \"notes = NULL\";\n121 }\n122\n123 if (strlen($input['title'])>0) {\n124 $title = \"title = '{$input['title']}'\";\n125 } else {\n126 $title = \"title = NULL\";\n127 }\n128\n129 if (! in_array(\n130 $input['article_type'],\n131 $article_types\n132 )) {\n133 $input['article_type'] = 1;\n134 }\n135\n136 $stm = \"UPDATE articles\n137 SET\n138 body = '{$input['body']}',\n139 $notes,\n140 $title,\n141 article_type = '{$input['article_type']}',\n142 ready = '{$input['ready']}',\n143 last_edited = '{$now}',\n144 ip = '{$_SERVER['REMOTE_ADDR']}',\n145 credits_per_rating = '{$input['credits_per_rating']}',\n146 max_ratings = '{$input['max_ratings']}'\n147 WHERE user_id = '{$user_id}'\n148 AND id = '{$input['id']}'\";\n149\n150 if (mysql_query($stm)) {\n151 $article_id = $input['id'];\n152\n153 if ($decrement) {\n154 // Charge them\n155 $stm = \"UPDATE users\n156 SET credits = credits - {$credits}\n157 WHERE user_id = '{$user_id}'\";\n158 mysql_query($stm);\n159 }\n160 } else {\n161 $failure[] = \"Could not update article.\";\n162 }\n163 } else {\n164 $failure[] = \"You do not have enough credits for ratings.\";\n165 }\n166 }\n167\n168 } else {\n169\n170 // creating a new article. do not decrement until specified.\n171 $decrement = false;\n172\n173 // if the article is ready, we need to subtract credits.\n174 if ($input['ready'] == 1) {\n175\n176 // if this is greater than or equal to 0, they may proceed.\n177 if (\n178 $credits > 0\n179 && $input['credits_per_rating']>=0.01\n180 && is_numeric($credits)\n181 ) {\n182 // minimum offering is 0.01\n183 $residual = $user->get('credits') - $credits;\n184 $decrement = true;\n185 } else {\n186 $residual = -1;\n187 $failure[] = \"Credit offering invalid.\";\n188 }\n189\n190 } else {\n191 // arbitrary positive value if they are not done with their article.\n192 // no deduction made yet.\n193 $residual = 1;\n194 }\n195\n196 // can user afford ratings on the new article?\n197 if ($residual >= 0) {\n198\n199 // yes, insert the article\n200 $stm = \"INSERT INTO articles (\n201 user_id,\n202 ip,\n203 last_edited,\n204 article_type\n205 ) VALUES (\n206 '{$user_id}',\n207 '{$_SERVER['REMOTE_ADDR']}',\n208 '$now',\n209 '$input['article_type']'\n210 )\";\n211\n212 if (mysql_query($stm)) {\n213 $article_id = mysql_insert_id();\n214 if ($decrement) {\n215 // Charge them\n216 $stm = \"UPDATE users\n217 SET credits = credits - {$credits}\n218 WHERE user_id='{$user_id}'\";\n219 mysql_query($stm);\n220 }\n221 } else {\n222 $failure[] = \"Could not update credits.\";\n223 }\n224\n225 $stm = \"UPDATE articles\n226 SET\n227 body = '{$input['body']}',\n228 $notes,\n229 $title,\n230 article_type = '{$input['article_type']}',\n231 ready = '{$input['ready']}',\n232 last_edited = '$now',\n233 ip = '{$_SERVER['REMOTE_ADDR']}',\n234 credits_per_rating = '{$input['credits_per_rating']}',\n235 max_ratings = '{$input['max_ratings']}'\n236 WHERE\n237 user_id = '{$user_id}'\n238 AND id = '$article_id'\n239 \";\n240\n241 if (! mysql_query($stm)) {\n242 $failure[] = \"Could not update article.\";\n243 }\n244\n245 } else {\n246\n247 // cannot afford ratings on new article\n248 $failure[] = \"You do not have enough credits for ratings.\";\n249 }\n250 }\n251 ?>\n```"]