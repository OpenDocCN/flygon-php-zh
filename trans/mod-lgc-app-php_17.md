# 第十七章。结论

让我们回顾一下我们的进展。

我们开始时是一个混乱的遗留应用程序。整个应用程序都基于文档根目录，并且用户直接浏览到页面脚本。它使用了一个包含导向的架构，仅仅包含一个文件就会导致逻辑被执行。全局变量随处可见，这使得调试变得困难甚至不可能。没有任何测试，更不用说单元测试，所以每次更改都可能导致其他地方出现问题。模型、视图和控制器层没有明确的分离。SQL 语句嵌入在我们的代码中，领域逻辑与展示和行为逻辑混在一起。

现在，在经过大量的努力、奉献和承诺之后，我们已经现代化了我们的遗留应用程序。文档根目录只包含公共资源和一个前端控制器。所有页面脚本都被分解成单独的模型、视图和控制器层。这些层由一系列良好结构的类表示，每个类都有自己的一套单元测试。应用程序对象是在依赖注入容器内构建的，使它们的操作与它们的创建分开。

还有什么可以做的吗？

# 改进机会

即使我们已经现代化了我们的应用程序，它仍然不完美。坦率地说，它将永远不会完美（无论这意味着什么）。总会有一些机会来改进它。事实上，现代化过程本身已经为我们揭示了许多机会。

+   数据源层由一系列网关组成。虽然它们现在很好地满足了我们的目的，但将这些重组为与我们的领域对象更清晰地交互的数据映射器可能更好。

+   领域层建立在事务脚本之上。这些也都有它们自己的好处，但在使用它们时，我们可能会意识到它们对我们的需求来说是不够的。它们将我们的领域逻辑的太多方面结合到了单块的类和方法中。我们可能会希望开始将我们的领域逻辑的不同方面分离出来，形成一个领域模型，并用一系列服务层来包装它。

+   展示层仍然相对来说是单块的。我们可能希望将我们的视图文件转换为一个两步视图系统。这将为我们提供一个统一的布局，提供一系列可重用的“部分”模板，并帮助我们将每个视图文件减少到其核心部分。

+   我们的控制器可能作为遗留架构的产物处理了几个不相关的操作。我们可能希望重新组织它们，以便更快地理解。事实上，每个控制器可能做的工作太多了（即一个臃肿的控制器而不是一个精简的控制器），这些工作可能更好地由辅助类或服务层来处理。

+   响应系统将内容构建与 HTTP 响应构建的问题结合在一起。我们可能希望重构整个响应发送过程为两个或更多个单独的层：一个处理响应主体，一个处理响应头。事实上，我们可能希望将响应表示为数据传输对象，描述我们的意图，但将实际的响应构建和发送交给一个单独的处理程序。

+   路由系统肯定是过渡性的。我们可能仍然依赖 URL 中的查询参数将客户端请求信息传递到应用程序中，而不是使用“美化的 URL”，其中参数被表示为路径信息的一部分。路由本身仅描述要调用的类，并没有携带应用程序应执行的动作的太多信息。我们将希望用更强大的路由器替换这个基本的路由器。

+   前端控制器充当我们的调度器，而不是将路由分发交给一个单独的对象。我们可能希望将发现路由信息的任务与分发该路由的任务分开。

+   最后，我们的依赖注入容器在本质上是非常“手动”的。我们可能希望找到一个能自动化一些对象创建的基本方面的容器系统，这样我们就可以集中精力解决服务定义的更复杂方面。

换句话说，我们面临的是现代代码库的问题，而不是遗留代码库的问题。我们已经将一个混乱的低质量问题换成了一个自动加载、依赖注入、单元测试、层分离、前端控制的高质量问题。

因为我们已经现代化了我们的代码库，我们可以以完全不同的方式解决这些问题，而不是在遗留体系下所做的。我们可以利用重构工具来改进代码。现在我们有了更好的关注点分离，我们可以在代码的有限部分进行小的改变，以提高代码的质量。每个改变都可以通过我们的单元测试套件进行回归测试。

我们添加的每个新功能都可以使用我们在现代化过程中获得的技术插入到我们的新应用程序架构中。我们不再随意地从以前的页面脚本中复制和修改一个新页面。相反，我们添加了一个经过单元测试的控制器类，并通过前端控制器路由到它。我们领域逻辑中的新功能是作为领域层中的经过单元测试的类或方法添加的。对呈现的更改和添加可以通过我们的视图层与我们的模型和控制器分开进行测试。

# 转换到框架

还有将我们的应用程序转换到最新、最热门的框架的可能性。虽然切换到一个公共框架有点像应用程序重写，但现在应该更容易，因为我们有一系列良好分离的应用程序层。我们应该能够确定哪些部分将被移植到公共框架，哪些只是我们特定架构运作的附属部分。

我不建议支持或反对这种方法。我只会指出，在现代化我们的遗留应用程序的过程中，我们实际上建立了我们自己定制的框架。我们所做的可能比 PHP 领域中大多数公共框架更加纪律严明和严格。虽然我们获得了与公共框架一起的社区，但我们也获得了框架开发者自己的包袱。这些以及其他权衡是我无法代表你来判断的；你必须自己决定利益是否超过成本。

# 回顾和下一步

无论我们从这里如何继续，毫无疑问，*应用程序*的改进已经导致了我们生活质量和专业方法的改进。我们在代码上投入的时间不仅在我们的就业方面得到了回报，我们现在花费更少的时间感到沮丧和泄气，更多的时间感到能干和富有成效。它在我们的技能、知识和应用架构、模式和实践方面也得到了回报。

我们现在的目标是继续改进我们的代码，继续改进自己，并帮助其他人也改进。我们需要分享我们的知识。通过这样做，我们将减少世界上因不得不处理遗留应用程序而产生的痛苦。当更多的人学会应用我们在这里学到的东西时，我们自己也可以继续处理更大、更好、更有趣的专业问题。

所以继续向你的同事、同胞和同事们传播这个好消息，他们不必因为不想要遗留应用程序而受苦。他们也可以现代化他们的代码库，并在这样做的过程中改善自己的生活。
