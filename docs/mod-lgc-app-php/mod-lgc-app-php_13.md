# 第十三章：分离公共和非公共资源

在这一点上，我们已经在重新组织我们传统应用程序的核心方面取得了重大进展。然而，周围的架构仍然有很多需要改进的地方。

除其他事项外，我们整个应用程序仍然嵌入在文档根中。这意味着我们需要对我们打算保持私有的资源进行特殊保护，或者我们需要依赖模糊来确保客户不会浏览到不打算公开的资源。Web 服务器配置错误或未注意特定的安全措施可能会将我们的应用程序部分展示给公众。

因此，我们的下一步是将所有公共资源提取到一个新的文档根目录。这将防止非公共资源被意外传送，并为进一步重构建立结构。

# 混合资源

目前，我们的 Web 服务器充当我们传统应用程序的组合前端控制器、路由器和调度器。页面脚本的路由直接映射到文件系统，使用 Web 服务器文档根作为基础。而 Web 服务器文档根又直接映射到传统应用程序的根目录。

例如，如果 Web 服务器文档根是`/var/www/htdocs`，它目前同时充当应用程序根。因此，URL 路径`/foo/bar.php`直接映射到`/var/www/htdocs/foo/bar.php`。

这对于公共资源可能没问题，但我们的应用程序中有很多部分是我们不希望外部直接访问的。例如，与配置和设置相关的目录不应该暴露给可能的外部检查。Web 服务器配置错误可能会暴露代码本身，使我们的密码和其他信息对恶意用户可用。

# 分离过程

尽管过程本身很简单，但我们正在进行的更改是基础性的。它影响了服务器配置以及传统应用程序结构。为了充分实现这一变化，我们需要与负责服务器部署的任何运营人员密切协调。

一般来说，流程如下：

1.  与运营协调以沟通我们的意图。

1.  在我们的传统应用程序中创建一个新的文档根目录，以及一个临时索引文件。

1.  重新配置服务器指向新的文档根目录，并抽查新配置，看看我们的临时索引文件是否出现。

1.  删除临时索引文件，然后将所有公共资源移动到新的文档根，并在此过程中进行抽查。

1.  提交、推送，并与运营协调进行 QA 测试。

## 与运营人员协调

这是整个过程中最重要的一步。我们绝不能在未与负责服务器的人员（我们的运营人员）讨论我们的意图的情况下进行影响服务器配置的更改。

运营的反馈将告诉我们我们需要遵循的路径，以确保我们的更改有效。他们将就新的文档根目录名称和新的服务器配置指令向我们提供建议或指导。他们负责部署应用程序，因此我们希望尽力让他们的工作尽可能轻松。如果运营不满意，那么每个人都会不开心。

或者，如果我们没有运营人员并且负责自己的部署，我们的工作既更容易又更困难。更容易是因为我们没有协调和沟通成本。更困难是因为我们需要特定的、详细的服务器配置知识。在这种情况下要小心进行。

## 创建文档根目录

与我们的运营人员协调后，我们在传统应用程序结构中创建了一个文档根目录。我们的运营联系人将会就适当的目录名称向我们提供建议；在这种情况下，让我们假设该名称是`docroot/`。

例如，如果我们当前有一个遗留的应用程序结构，看起来像这样：

**var/www/htdocs/**

```php
classes/
 ... 
css/
 ... 
foo/
    bar/
        baz.php
images/
 ... 
includes/
 ... 
index.php
js/
tests/
 ... 
views/
 ... 
```

...我们在应用程序的顶层添加一个新的`docroot/`目录。在新的文档根目录中，我们添加一个临时的`index.html`文件。这将让我们以后知道我们的服务器重新配置是否正常工作。它可以包含任何我们喜欢的文本，比如“庆祝！新配置有效！”。

完成后，新的目录结构将更像这样：

**/var/www/htdocs/**

```php
classes/
 ... 
css/
 ... 
docroot/
    index.html
foo/
    bar/
        baz.php
images/
 ... 
includes/
 ... 
index.php
    js/
 ... 
tests/
 ... 
views/
 ... 
```

## 重新配置服务器

我们现在重新配置我们的本地开发网络服务器，指向新的`docroot/`目录。我们的运维人员应该已经给了我们一些关于如何做这件事的指示。

在 Apache 中，我们可能需要编辑我们本地开发环境的配置文件，将相关的`.conf`文件中的`DocumentRoot`指令从主应用程序目录更改为新的目录：

```php
DocumentRoot "/var/www/htdocs"
```

...到我们在应用程序中新创建的子目录：

```php
DocumentRoot "/var/www/htdocs/docroot"
```

然后我们保存文件，并重新加载或重启服务器以应用我们的更改。

### 提示

适用的`DocumentRoot`指令可能在许多位置之一。它可能在主`httpd.conf`文件中，或者作为`VirtualHost`指令的一部分在单独的配置文件中。如果我们使用的不是 Apache，配置可能在一个完全不同的文件中。不幸的是，本书范围之外无法提供完整的 Web 服务器管理说明。请查阅您特定服务器的文档以获取更多信息。

应用我们的配置更改后，我们浏览遗留应用程序，看新的文档根是否被遵守。我们应该看到我们临时的`index.html`文件的内容。如果没有，我们做错了什么，需要重新检查我们的更改，直到它们按预期工作。

## 移动公共资源

现在我们已经配置了 Web 服务器指向我们的新`docroot/`目录，我们可以安全地删除我们的临时`index.html`文件。

这样做之后，我们的下一步是将所有公共资源从它们当前的位置移动到新的`docroot/`目录中。这包括我们所有的页面脚本、样式表、JavaScript 文件、图片等等。不包括任何用户不应该能够浏览到的东西：类、包含文件、设置、配置、命令行脚本、测试、视图文件等等。

我们希望在`docroot/`中保持与在应用程序基础目录中相同的相对位置，因此在移动时不应更改文件名或目录名。

当我们将我们的公共资源移动到新的位置时，我们应该偶尔通过应用程序浏览来检查我们修改后的结构。这将帮助我们及早发现任何问题，而不是晚些时候。

### 提示

我们移动的一些 PHP 文件可能仍然依赖于特定位置的`include`文件。在这些情况下，我们可能需要修改它们，指向相对于我们新的`docroot/`目录的路径。或者，我们可能需要修改我们的包含路径值，以便它们可以找到必要的文件。

完成后，我们将拥有一个看起来更像这样的目录结构：

**/var/www/htdocs/**

```php
classes/
 ... 
docroot/
   css/
       ... 
   foo/
       bar/
          baz.php

   index.php
   js/
     ... 
   images/
     ... 
includes/
    ... 
tests/
    ... 
views/
    ... 
```

## 提交、推送、协调

当我们将所有的公共资源移动到新的`docroot/`目录，并且遗留应用程序在这个新结构中正常工作时，我们提交所有的更改并将它们推送到公共存储库。

在这一点上，我们通常会通知 QA 我们的更改以供测试。然而，因为我们对服务器配置进行了基础性的更改，我们需要与运维人员协调 QA 测试。运维人员可能需要部署新的配置到 QA 服务器。只有这样，QA 才能有效地检查我们的工作。

# 常见问题

## 这真的有必要吗？

大多数时候，将各种非公共资源留在文档根目录似乎是无害的。但对于我们接下来的步骤来说，非常重要的是我们要在我们的公共资源和非公共资源之间有一个分离。

# 审查和下一步操作

我们现在已经开始重构我们遗留应用的总体架构。通过创建一个文档根目录，将我们的公共资源与非公共资源分开，我们可以开始组建一个前端控制器系统来控制对我们应用的访问。
