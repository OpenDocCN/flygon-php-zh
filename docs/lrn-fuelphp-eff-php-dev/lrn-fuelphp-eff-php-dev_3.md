# 第三章：架构

在我们开始使用新安装的 FuelPHP 版本构建任何内容之前，让我们首先看一下架构的一些主要方面。我们还将涵盖一些应该将代码放置在项目中的地方，然后在下一章中提供示例。

在本章中，我们将涵盖以下主题：

+   环境、常量和配置

+   Apache 配置

+   FuelPHP 引导

+   模型、视图和控制器

# 环境、常量和配置

任何开发人员都会告诉您，直接在实时生产环境中编辑文件绝不是一个好主意。为此，FuelPHP 将环境的概念内置到其核心中。环境允许在项目生命周期的每个阶段中进行不同的配置。FuelPHP 支持四种环境设置，如下所示：

+   `\Fuel::DEVELOPMENT`：这是默认的环境设置，也是您将开始的地方

+   `\Fuel::TEST`：这是您可以使用测试数据运行代码的地方

+   `\Fuel::STAGING`：这是您获得客户批准和接受的地方

+   `\Fuel::PRODUCTION`：这是实时环境

如果环境未设置，代码将以开发模式运行。可以通过多种方式设置环境。

## 服务器和 Apache 配置

本节将教您设置环境变量的可能是最简单的方法，但前提是您可以访问项目域的 Apache 配置或虚拟主机文件。在配置或虚拟主机文件中，只需包含以下代码：

```php
SetEnv FUEL_ENV production
```

### 注意

`FUEL_ENV`代码需要大写，因为它是一个 PHP 常量

## 引导 PHP 文件

如果您无法访问服务器配置并希望获得它，另一种方法是在应用程序引导中设置环境。这可以在`fuel/app/`中的`bootstrap.php`文件中使用以下代码完成：

```php
Fuel::$env = ( isset( $_SERVER['FUEL_ENV'] )? $_SERVER['FUEL_ENV'] : Fuel::PRODUCTION ;
```

## 配置

一旦配置了环境，就值得考虑项目的配置。FuelPHP 在自动加载配置时遵循一种层次结构。这对于数据库设置非常方便，这意味着您的生产连接可以更安全地用于生产和分段环境。事实上，团队甚至不需要访问数据库凭据就可以在项目上工作。配置目录结构可以类似于以下代码：

```php
app/
    config/
        db.php
        development/
            db.php
        staging/
            db.php
        test/
            bd.php
        production/
            db.php 
```

环境目录中的设置被视为比较高级目录中的设置更重要，从而实现了细粒度的配置控制和回退。这对于测试和确保每个环境可以以不同的方式配置非常有用，例如第三方 API 连接详细信息。

对于包配置，也遵循相同的层次结构。在这种情况下，应用程序配置文件夹中的包配置比包目录中的配置更重要。这允许在`app/config`文件夹中的配置文件中覆盖包中的默认选项。

## 常量

关于包，其文件夹路径的详细信息采用常量的形式。以下是在引导文件中设置的 PHP 常量：

+   `APPPATH`：应用程序目录的路径，您的应用程序代码和目录位于其中

+   `COREPATH`：FuelPHP 核心文件的路径

+   `DOCROOT`：用于资源和`index.php`文件的公共文件夹

+   `PKGPATH`：包目录路径

+   `VENDORPATH`：composer 根目录的路径

# 模型、视图和控制器

在没有提到**模型-视图-控制器**（**MVC**）设计模式的架构中是不完整的。如果您以前编写过 PHP，或者查看过其他众多框架，您可能已经听说过 MVC 模式。它允许代码的逻辑分离。控制器处理逻辑，而模型确保数据的一致性，并执行与数据存储的交互。视图向用户呈现控制器和模型的结果。到目前为止，一切都很好；为什么要提到 MVC 模式？嗯，FuelPHP 引入了 ViewModel 和一些基本类，为您的项目提供了一个快速入门。

## 视图和 ViewModels

视图存储在`app`文件夹中的`views`文件夹中，例如，`fuel/app/views`。

它们可以被分组放在子文件夹中，并且通常与控制器操作直接相关，例如，`login.php`位于`fuel/app/views/user/`中，将与`user`控制器中的`login`方法相关联。它还将具有`user/login`的类名。

值得注意的是，视图可以使用从控制器或 ViewModel 传递给它的变量。它们还可以使用任何核心 FuelPHP 类和本机 PHP 函数。为了帮助将逻辑与表示分离，建议仅使用基本的`if`语句和循环。

安全性始终很重要，因此传递给视图的所有变量都将使用配置的输出过滤器进行清理-通常是`Security::htmlentities()`。这种行为可以从每个控制器内部更改或禁用，配置文件中运行的默认函数也可以更改。

为了减少 FuelPHP 应用程序的内存占用，视图是“延迟加载”的。这意味着它们只在调用或回显时才会被渲染。

我们之前提到了 ViewModels；这些作为控制器和视图之间的粘合剂。当应用程序开始变得复杂时，很难决定一段代码是否应该放在控制器或视图中。代码可能与应用程序逻辑无关，而与表示逻辑有关。这就是 ViewModels 的用处所在。

ViewModel 在用户输入发生后发挥作用。然后检索视图所需的数据。它们不处理数据，但可以在视图之前与数据存储交互。

## 模型

FuelPHP 核心模型（`Model_Crud`）包括基本的 CRUD（创建、读取、更新和删除）函数，使其快速且易于开始使用数据存储。它只是用于处理表格的快捷方式，不是 ORM 包的一部分。`Model_Crud`和`ORM`包的命名约定相同；这使得更新到 ORM 包以进行更复杂的数据交互变得非常容易。ORM 包包括许多高级功能，从软删除到时间历史记录保留。

使用 ORM 包将需要您定义有关数据的更多详细信息，例如数据库表之间的关系。在下一章构建示例应用程序时，我们将涉及其中一些内容。

## 控制器

控制器是应用程序中更有趣的部分发生的地方。与项目的其他部分一样，代码在以下文件夹结构中具有逻辑位置。控制器放在`fuel/app/classes/controller`文件夹中。

路由器获取 URL，加载所需的控制器，然后将请求传递给控制器内对应的操作或方法。例如，导航到`http://project.dev/home/index` URL 将调用主页控制器中的`index`方法。控制器的结构看起来可能是这样的：

```php
class Controller_Home extends Controller
{
    public function action_index()
    {
        $data['css'] = Asset::css(array('reset.css','site.css'));
        return Response::forge( View::forge('home/index'));
    }
}
```

### 注意

控制器内的操作或方法以 action_ 为前缀，这是为了帮助您使用保留的 PHP 方法名称，例如`list`，并且仍然为控制器方法提供逻辑名称。其他方法可以被创建，但没有`action_`前缀，它们只能直接调用，而不是通过 URL 调用。

如果您正在构建 API 或设置 AJAX 系统，可以将方法分离出来。在下面的示例中，`action_example`将接受 GET 请求，而 POST 请求将转到`post_example`方法，如下所示：

```php
class Controller_Home extends Controller
{
     public action_example(){
       // Add your code here
     }
     public post_example(){
       // Add your code here
     }
}
```

当创建应用程序时，此功能将与基础控制器模板一起发挥作用。`action_`和`post_`方法的分离只适用于混合或 rest 基础控制器。有四个基本模板——base、template、rest 和 hybrid。

### 模板

模板控制器是基础控制器的扩展，之前提到过，它具有内置的模板支持，使用预定义的`before()`和`after()`方法。它可以用来在布局中包装您的视图，并带有页眉和页脚。您的布局模板应存储在`fuel/app/views/template.php`中。

### Rest

与模板控制器类似，rest 控制器是基础控制器的扩展。它不是内置模板支持操作，而是内置 RESTful 支持，使构建 API 更容易。

### 注意

如果在您的 rest 控制器中添加了`before()`或路由器方法，您将需要调用父方法`parent::before()`才能使所有这些方法都起作用。

### 混合

混合控制器将 rest 和模板控制器结合在一起。

# 摘要

在本章中，我们已经了解了 FuelPHP 架构的一些基本部分。我们已经看到 FuelPHP 提供了一个很好的起点，具有可扩展的控制器和模型。这些为大多数项目提供了一个很好的起点，并引入了一些功能，这是任何 PHP 框架的首次；例如，时间 ORM 模型。

在下一章中，我们将开始使用这些知识来创建演示应用程序。
